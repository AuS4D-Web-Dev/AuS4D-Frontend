name: üîí Gate to main

on:
    pull_request:
        branches: [main]

permissions:
    contents: read
    statuses: read

jobs:
    verify-prod-test-pass:
        name: üîç Verify commit passed on prod-test
        runs-on: ubuntu-latest

        steps:
            - name: üîç Check prod-test CI
              uses: actions/github-script@v7
              with:
                  script: |
                      const sha = context.payload.pull_request.head.sha;
                      const owner = context.repo.owner;
                      const repo = context.repo.repo;

                      // ‚úÖ Áõ¥Êé•‰ªé prod-test ÂàÜÊîØÊü•ÊâæËØ• commit ÁöÑÁä∂ÊÄÅ
                      const { data: statuses } = await github.request(
                        'GET /repos/{owner}/{repo}/commits/{ref}/statuses',
                        { owner, repo, ref: sha }
                      );

                      const ok = statuses.some(s =>
                        s.context === "prod-test/ci" && s.state === "success"
                      );

                      if (!ok) {
                        core.setFailed(`‚ùå Commit ${sha.slice(0,7)} has not passed prod-test/ci.`);
                      } else {
                        core.info(`‚úÖ Commit ${sha.slice(0,7)} passed prod-test/ci.`);
                      }
